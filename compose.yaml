services:
  rabbitmq:
    image: "rabbitmq:3-management-alpine"
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - dapr-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "check_port_connectivity"]
      interval: 5s
      timeout: 30s
      retries: 5

############################################### 
#               UsersManager

  users_manager:
    image: users_manager-image
    build:
      context: ./Managers/usersManager
      dockerfile: Dockerfile
    ports:
      - "3001:3001"
    networks:
      - dapr-network
    volumes:
      - ./dapr/components:/dapr/components
    depends_on:
      rabbitmq:
        condition: service_healthy

  dapr_users_manager:
    image: "daprio/daprd:latest"
    command: [
      "./daprd",
      "-app-id", "usersManager",
      "-app-port", "3001",
      "-dapr-http-port", "3501",
      "-dapr-grpc-port", "50001",
      "-components-path", "/dapr/components"
    ]
    volumes:
      - ./dapr/components:/dapr/components
    depends_on:
      users_manager:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    network_mode: "service:users_manager"

############################################### 
#               NewsManager

  news_manager:
    image: news_manager-image
    build:
      context: ./Managers/newsManager
      dockerfile: Dockerfile
    ports:
      - "3002:3002"
    networks:
      - dapr-network
    volumes:
      - ./dapr/components:/dapr/components
    depends_on:
      rabbitmq:
        condition: service_healthy

  dapr_news_manager:
    image: "daprio/daprd:latest"
    command: [
      "./daprd",
      "-app-id", "news_manager",
      "-app-port", "3002",
      "-dapr-http-port", "3502",
      "-dapr-grpc-port", "50002",
      "-components-path", "/dapr/components"
    ]
    volumes:
      - ./dapr/components:/dapr/components
    depends_on:
      news_manager:
        condition: service_started
      rabbitmq:
        condition: service_healthy
    network_mode: "service:news_manager"

############################################### 
#               NewsApiAccessor

  news_api_accessor:
    image: news_api_accessor-image
    build:
      context: ./Accessors/newsApiAccessor
      dockerfile: Dockerfile
    ports:
      - "3003:3003"
    networks:
      - dapr-network
    volumes:
      - ./dapr/components:/dapr/components  # Optional ?
    depends_on:
      rabbitmq:
        condition: service_healthy          # Optional ?
      news_manager:
        condition: service_started

  dapr_news_api_accessor:
    image: "daprio/daprd:latest"
    command: [
      "./daprd",
      "-app-id", "news_api_accessor",
      "-app-port", "3003",
      "-dapr-http-port", "3503",
      "-dapr-grpc-port", "50003",
      "-components-path", "/dapr/components"
    ]
    volumes:
      - ./dapr/components:/dapr/components  # Optional ?
    depends_on:
      news_api_accessor:
        condition: service_started
    network_mode: "service:news_api_accessor"

############################################### 
#               MailAccessor

  mail_accessor:
    image: mail_accessor-image
    build:
      context: ./Accessors/MailAccessor
      dockerfile: Dockerfile
    ports:
      - "3004:3004"
    networks:
      - dapr-network
    volumes:
      - ./dapr/components:/dapr/components  # Optional ?
    depends_on:
      rabbitmq:
        condition: service_healthy          # Optional ?
      news_manager:
        condition: service_started

  dapr_mail_accessor:
    image: "daprio/daprd:latest"
    command: [
      "./daprd",
      "-app-id", "mail_accessor",
      "-app-port", "3004",
      "-dapr-http-port", "3504",
      "-dapr-grpc-port", "50004",
      "-components-path", "/dapr/components"
    ]
    volumes:
      - ./dapr/components:/dapr/components  # Optional ?
    depends_on:
      mail_accessor:
        condition: service_started
    network_mode: "service:mail_accessor"


networks:
  dapr-network:
    driver: bridge